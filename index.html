<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Club Pets & Jack</title>
    <style>
        /* --- ESTILOS VISUALES --- */
        :root { --primary: #2c3e50; --classic: #3498db; --elite: #f1c40f; --bg: #f4f6f7; --text: #333; }
        body { font-family: 'Helvetica', 'Arial', sans-serif; margin: 0; padding: 0; background-color: var(--bg); color: var(--text); }
        
        header { background: var(--primary); color: white; padding: 1.5rem 1rem; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        header h1 { margin: 0; font-size: 1.5rem; }
        header p { margin: 5px 0 0; opacity: 0.9; font-size: 0.9rem; }

        .container { max-width: 600px; margin: 0 auto; padding: 20px; }
        
        .card { background: white; padding: 20px; margin-bottom: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); position: relative; }
        
        h2 { font-size: 1.3rem; margin-top: 0; color: var(--primary); }
        h3 { font-size: 1.1rem; margin-top: 0; margin-bottom: 10px; }
        
        /* FORMULARIO ESTILOS */
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
        .form-input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 16px; box-sizing: border-box; }
        .form-input:read-only { background-color: #eee; color: #777; }
        select.form-input { background: white; }

        /* BOTONES */
        .btn { display: block; width: 100%; padding: 15px 0; border: none; border-radius: 8px; font-weight: bold; text-align: center; text-decoration: none; font-size: 16px; cursor: pointer; margin-top: 10px; transition: transform 0.1s; box-sizing: border-box; -webkit-appearance: none; }
        .btn:active { transform: scale(0.98); }
        
        .btn-classic { background-color: var(--classic); color: white; }
        .btn-elite { background-color: var(--elite); color: #333; }
        .btn-whatsapp { background-color: #25D366; color: white; }
        .btn-insta { background: linear-gradient(45deg, #405de6, #5851db, #833ab4, #c13584, #e1306c, #fd1d1d); color: white; }
        .btn-submit { background-color: #e67e22; color: white; } 
        .btn-outline { background: transparent; border: 2px solid #ccc; color: #666; }

        /* BARRA DE PROGRESO */
        .progress-container { background: #eee; height: 20px; border-radius: 10px; overflow: hidden; margin: 10px 0; position: relative; }
        .progress-fill { height: 100%; border-radius: 10px; transition: width 1s ease-in-out; width: 0%; display: flex; align-items: center; justify-content: flex-end; }
        .progress-text { position: absolute; width: 100%; text-align: center; line-height: 20px; font-size: 0.8rem; font-weight: bold; color: #555; }

        .hidden { display: none !important; }
        .loading { text-align: center; padding: 50px; color: #666; }
    </style>
</head>
<body>

<script>
    // 1. LINK PARA LEER DATOS (CSV PUBLICADO EN LA WEB)
    const LINK_CSV_GOOGLE = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTJpAvsHXGVClF4DdMpE7ZIV8HDdUMEC5GTny_zbYnjQbNbCgeo5_m_pR4aqEPuoc9kZZH1y8aZynnV/pub?gid=0&single=true&output=csv"; 

    // 2. LINK PARA ESCRIBIR DATOS (URL DEL APP SCRIPT QUE CREASTE)
    const URL_SCRIPT_GOOGLE = "https://script.google.com/macros/s/AKfycbyc5cNow8vYQtKZONJDJU67jT2n-N-n29uf-YQjGSc6g1tQwXLvJ3XJGlDbj-8enFM/exec";

    // 3. DATOS DE CONTACTO
    const WHATSAPP_TIENDA = "56993525112"; 
    const LINK_INSTAGRAM = "https://www.instagram.com/pets.jackk/";
</script>

<div id="loading-screen" class="loading">
    <h2>Cargando...</h2>
    <p>Conectando con la base de datos</p>
</div>

<div id="view-register" class="hidden">
    <header style="background: #e67e22;">
        <h1>Registro de Socio</h1>
        <p>Activa tu tarjeta ahora</p>
    </header>
    <div class="container">
        <div class="card">
            <form id="registroForm" onsubmit="enviarRegistro(event)">
                <div class="form-group">
                    <label class="form-label">ID Tarjeta (Autom√°tico)</label>
                    <input type="text" name="id_tarjeta" id="reg-id" class="form-input" readonly>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Nombre Completo</label>
                    <input type="text" name="nombre" class="form-input" placeholder="Ej: Juan P√©rez" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Tel√©fono</label>
                    <input type="tel" name="telefono" class="form-input" placeholder="Ej: 56912345678" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" name="email" class="form-input" placeholder="juan@correo.cl" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Tipo de Socio</label>
                    <select name="tipo_socio" class="form-input">
                        <option value="Classic">Classic (Azul)</option>
                        <option value="Elite">√âlite (Dorada)</option>
                    </select>
                </div>

                <input type="hidden" name="fecha" value="HOY">
                <input type="hidden" name="sacos" value="0">

                <button type="submit" id="btn-submit" class="btn btn-submit">‚úÖ Guardar y Activar</button>
                <p id="status-msg" style="text-align:center; color:#666; margin-top:10px;"></p>
            </form>
        </div>
    </div>
</div>

<div id="view-public" class="hidden">
    <header><h1>Pets & Jack</h1><p>Bienvenido al Club</p></header>
    <div class="container">
        <div class="card">
            <h2>¬øYa eres socio?</h2>
            <p>Acerca tu celular a tu tarjeta NFC para ver tus puntos.</p>
        </div>
        <div class="card">
            <h3>Compra tu Membres√≠a</h3>
            <a href="#" onclick="conectarWhatsApp('Hola, quiero comprar una membres√≠a.')" class="btn btn-whatsapp">Comprar por WhatsApp</a>
        </div>
    </div>
</div>

<div id="view-classic" class="hidden">
    <header style="background: var(--classic);">
        <h1 id="saludo-classic">Hola, Socio</h1>
        <p>ID: <span id="display-id-classic">...</span></p>
    </header>
    <div class="container">
        <div class="card">
            <h3>üéÅ Tu Progreso de Sacos</h3>
            <p id="texto-sacos-classic">Cargando...</p>
            <div class="progress-container">
                <span class="progress-text" id="label-barra-classic">0/10</span>
                <div class="progress-fill" id="barra-classic" style="background: var(--classic);"></div>
            </div>
            <p id="mensaje-falta-classic" style="font-size:0.8rem; color:#999; text-align: center;">...</p>
            <a href="#" onclick="registrarSaco('Classic')" class="btn btn-classic">üõí Registrar Nuevo Saco</a>
        </div>
        <div class="card">
            <span style="background: var(--classic); color: white; padding: 4px 10px; border-radius: 15px; font-size: 0.8rem;">ACTIVO</span>
            <h3>5% Descuento en Tienda</h3>
        </div>
        <button onclick="cerrarSesion()" class="btn btn-outline">Cerrar Sesi√≥n</button>
    </div>
</div>

<div id="view-elite" class="hidden">
    <header style="background: var(--elite); color: #333;">
        <h1 id="saludo-elite">Hola, Socio üëë</h1>
        <p>ID: <span id="display-id-elite">...</span></p>
    </header>
    <div class="container">
        <div class="card" style="background: linear-gradient(to right, #fff, #fffdf5);">
            <h3>üéÅ Progreso VIP</h3>
            <p id="texto-sacos-elite">Cargando...</p>
            <div class="progress-container">
                <span class="progress-text" id="label-barra-elite">0/10</span>
                <div class="progress-fill" id="barra-elite" style="background: var(--elite);"></div>
            </div>
             <a href="#" onclick="registrarSaco('Elite')" class="btn btn-elite">üõí Registrar Nuevo Saco</a>
        </div>
        <div class="card">
            <span style="background: var(--elite); color: #333; padding: 4px 10px; border-radius: 15px; font-size: 0.8rem;">VIP ACTIVO</span>
            <h3>10% Descuento + Sorteos</h3>
        </div>
        <div class="card">
            <h3>üéâ Sorteos Mensuales</h3>
            <a href="#" onclick="window.open(LINK_INSTAGRAM, '_blank')" class="btn btn-insta">üì∏ Ver Premios en Instagram</a>
        </div>
        <div class="card">
            <h3>üí≥ Reposici√≥n Gratuita</h3>
            <a href="#" onclick="conectarWhatsApp('Hola, soy Socio Elite y necesito reponer mi tarjeta gratis.')" class="btn btn-outline">Solicitar Reposici√≥n</a>
        </div>
        <button onclick="cerrarSesion()" class="btn btn-outline">Cerrar Sesi√≥n</button>
    </div>
</div>

<script>
    let currentId = "Invitado";
    let currentName = "";
    let currentSacos = 0;

    window.onload = function() {
        const params = new URLSearchParams(window.location.search);
        const idURL = params.get('id');
        
        if (!idURL) {
            mostrarVista('public');
            return;
        }
        
        currentId = idURL;
        // Verificar si existe en la base de datos
        verificarUsuario(idURL);
    };

    // --- VERIFICACI√ìN (LEER EXCEL) ---
    function verificarUsuario(idBuscado) {
        fetch(LINK_CSV_GOOGLE)
            .then(response => response.text())
            .then(textoCSV => {
                const usuario = buscarEnCSV(textoCSV, idBuscado);
                
                if (usuario) {
                    // EXISTE: Cargar perfil
                    currentName = usuario.nombre;
                    currentSacos = parseInt(usuario.sacos) || 0;
                    actualizarInterfaz(usuario.tipoSocio.toLowerCase().trim());
                } else {
                    // NO EXISTE: Mostrar Formulario de Registro
                    mostrarVista('register');
                    document.getElementById('reg-id').value = idBuscado; // Auto-llenar ID
                }
            })
            .catch(err => { alert("Error conectando."); mostrarVista('public'); });
    }

    // --- REGISTRO (ESCRIBIR EN EXCEL) ---
    function enviarRegistro(e) {
        e.preventDefault();
        const btn = document.getElementById('btn-submit');
        const status = document.getElementById('status-msg');
        const form = document.forms['registroForm'];

        btn.disabled = true;
        btn.innerText = "Guardando...";
        status.innerText = "Enviando datos al servidor...";

        fetch(URL_SCRIPT_GOOGLE, { method: 'POST', body: new FormData(form)})
        .then(response => {
            status.innerText = "‚úÖ ¬°Registro Exitoso! Entrando...";
            // Recargar la p√°gina para entrar autom√°ticamente
            setTimeout(() => { location.reload(); }, 1500);
        })
        .catch(error => {
            status.innerText = "‚ùå Error al guardar. Intenta de nuevo.";
            btn.disabled = false;
            btn.innerText = "Guardar y Activar";
        });
    }

    // --- UTILIDADES ---
    function buscarEnCSV(csv, idBuscado) {
        const filas = csv.split('\n');
        for (let i = 1; i < filas.length; i++) {
            const cols = filas[i].split(','); 
            // Ajusta √≠ndices seg√∫n el orden exacto de columnas en tu Excel
            // A=0 (fecha), B=1 (id), C=2 (nombre), D=3 (tel), E=4 (email), F=5 (sacos), G=6 (tipo)
            if (cols.length < 2) continue;
            
            // Limpiamos comillas por si acaso
            const idExcel = cols[1].replace(/"/g, '').trim();
            
            if (idExcel === idBuscado) {
                return {
                    nombre: cols[2].replace(/"/g, ''),
                    telefono: cols[3],
                    sacos: cols[5],
                    tipoSocio: cols[6]
                };
            }
        }
        return null;
    }

    function actualizarInterfaz(tipo) {
        document.getElementById('display-id-classic').innerText = currentId;
        document.getElementById('display-id-elite').innerText = currentId;
        document.getElementById('saludo-classic').innerText = "Hola, " + currentName.split(" ")[0];
        document.getElementById('saludo-elite').innerText = "Hola, " + currentName.split(" ")[0];
        
        actualizarBarra(currentSacos, tipo);

        if (tipo.includes('classic')) mostrarVista('classic');
        else if (tipo.includes('elite')) mostrarVista('elite');
        else mostrarVista('classic');
    }

    function mostrarVista(nombre) {
        document.getElementById('loading-screen').classList.add('hidden');
        document.getElementById('view-public').classList.add('hidden');
        document.getElementById('view-register').classList.add('hidden'); // Nuevo
        document.getElementById('view-classic').classList.add('hidden');
        document.getElementById('view-elite').classList.add('hidden');

        if (nombre === 'public') document.getElementById('view-public').classList.remove('hidden');
        if (nombre === 'register') document.getElementById('view-register').classList.remove('hidden');
        if (nombre === 'classic') document.getElementById('view-classic').classList.remove('hidden');
        if (nombre === 'elite') document.getElementById('view-elite').classList.remove('hidden');
    }

    function actualizarBarra(n, tipo) {
        let porcentaje = (n / 10) * 100;
        if (porcentaje > 100) porcentaje = 100;
        let faltan = 10 - n;
        let sufijo = tipo.includes('elite') ? 'elite' : 'classic';

        document.getElementById(`texto-sacos-${sufijo}`).innerHTML = `Llevas <strong>${n} de 10</strong> sacos.`;
        document.getElementById(`barra-${sufijo}`).style.width = `${porcentaje}%`;
        if(sufijo === 'classic') document.getElementById('mensaje-falta-classic').innerText = faltan <= 0 ? "¬°Premio!" : `Faltan ${faltan}.`;
    }

    function registrarSaco(tipoSocio) {
        let msg = `Hola, soy ${currentName} (ID: ${currentId}, Socio ${tipoSocio}). Quiero registrar un saco.`;
        conectarWhatsApp(msg);
    }
    function conectarWhatsApp(mensaje) {
        let url = `https://wa.me/${WHATSAPP_TIENDA.replace(/\D/g,'')}?text=${encodeURIComponent(mensaje)}`;
        window.open(url, '_blank');
    }
    function cerrarSesion() { window.location.href = window.location.pathname; }
</script>

</body>
</html>
