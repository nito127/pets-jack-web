<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Club Pets & Jack</title>
    <style>
        /* --- ESTILOS VISUALES --- */
        :root { --primary: #2c3e50; --classic: #3498db; --elite: #f1c40f; --bg: #f4f6f7; --text: #333; }
        body { font-family: 'Helvetica', 'Arial', sans-serif; margin: 0; padding: 0; background-color: var(--bg); color: var(--text); }
        
        header { background: var(--primary); color: white; padding: 1.5rem 1rem; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        header h1 { margin: 0; font-size: 1.5rem; }
        header p { margin: 5px 0 0; opacity: 0.9; font-size: 0.9rem; }

        .container { max-width: 600px; margin: 0 auto; padding: 20px; }
        
        .card { background: white; padding: 20px; margin-bottom: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); position: relative; }
        
        h2 { font-size: 1.3rem; margin-top: 0; color: var(--primary); }
        h3 { font-size: 1.1rem; margin-top: 0; margin-bottom: 10px; }
        ul { padding-left: 20px; color: #555; margin-bottom: 20px; }
        li { margin-bottom: 5px; }

        /* INPUTS FORMULARIO */
        .input-group { margin-bottom: 15px; text-align: left; }
        .input-group label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.9rem; }
        .input-field { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem; box-sizing: border-box; }
        .input-field:focus { border-color: var(--primary); outline: none; }

        /* BOTONES */
        .btn { 
            display: block; width: 100%; padding: 15px 0; border: none; border-radius: 8px; 
            font-weight: bold; text-align: center; text-decoration: none; font-size: 16px; 
            cursor: pointer; margin-top: 10px; transition: transform 0.1s; box-sizing: border-box; 
            -webkit-appearance: none; 
        }
        .btn:active { transform: scale(0.98); }
        
        .btn-classic { background-color: var(--classic); color: white; box-shadow: 0 4px 6px rgba(52, 152, 219, 0.2); }
        .btn-elite { background-color: var(--elite); color: #333; box-shadow: 0 4px 6px rgba(241, 196, 15, 0.3); }
        .btn-whatsapp { background-color: #25D366; color: white; }
        .btn-insta { background: linear-gradient(45deg, #405de6, #5851db, #833ab4, #c13584, #e1306c, #fd1d1d); color: white; }
        .btn-outline { background: transparent; border: 2px solid #ccc; color: #666; }
        .btn-cancel { background-color: #e74c3c; color: white; margin-top: 10px; }

        /* BARRA DE PROGRESO */
        .progress-container { background: #eee; height: 20px; border-radius: 10px; overflow: hidden; margin: 10px 0; position: relative; }
        .progress-fill { height: 100%; border-radius: 10px; transition: width 1s ease-in-out; width: 0%; display: flex; align-items: center; justify-content: flex-end; }
        .progress-text { position: absolute; width: 100%; text-align: center; line-height: 20px; font-size: 0.8rem; font-weight: bold; color: #555; }

        .hidden { display: none !important; }
    </style>
</head>
<body>

<div id="view-public" class="hidden">
    <header>
        <h1>Pets & Jack</h1>
        <p>Elige tu membres√≠a o escanea tu tarjeta</p>
    </header>
    
    <div class="container">
        <div class="card" style="border-top: 5px solid var(--classic);">
            <h2 style="color: var(--classic);">üîµ Membres√≠a Classic</h2>
            <ul>
                <li>5% Descuento Permanente</li>
                <li>Regalo cada 10 sacos</li>
                <li>Acceso anticipado 48h</li>
            </ul>
            <button onclick="abrirFormularioRegistro('classic')" class="btn btn-classic">
                Registrarme en Classic
            </button>
        </div>

        <div class="card" style="border-top: 5px solid var(--elite);">
            <h2 style="color: #b7950b;">üëë Membres√≠a √âlite</h2>
            <ul>
                <li>10% Descuento Permanente</li>
                <li>Sorteos Mensuales</li>
                <li>3 Reposiciones Gratis</li>
            </ul>
            <button onclick="abrirFormularioRegistro('elite')" class="btn btn-elite">
                Registrarme en √âlite
            </button>
        </div>

        <div style="text-align: center; margin-top: 30px; color: #999; font-size: 0.9rem;">
            <p>¬øYa tienes tu tarjeta? <br>Acerca tu celular a ella ahora.</p>
        </div>
    </div>
</div>

<div id="view-registro" class="hidden">
    <header>
        <h1>Crear Cuenta</h1>
        <p>Ingresa tus datos para generar tu ID</p>
    </header>
    <div class="container">
        <div class="card">
            <h2 id="titulo-registro">Registro Nuevo Socio</h2>
            <p style="margin-bottom:20px; color:#666;">Est√°s a un paso de obtener tus beneficios.</p>
            
            <div class="input-group">
                <label>Nombre Completo:</label>
                <input type="text" id="reg-nombre" class="input-field" placeholder="Ej: Juan P√©rez">
            </div>

            <div class="input-group">
                <label>Tel√©fono:</label>
                <input type="tel" id="reg-telefono" class="input-field" placeholder="Ej: 56912345678">
            </div>

            <button onclick="guardarRegistro()" class="btn" id="btn-confirmar-reg" style="background: var(--primary); color:white;">
                Confirmar y Crear ID
            </button>
            <button onclick="cancelarRegistro()" class="btn btn-outline">
                Cancelar
            </button>
        </div>
    </div>
</div>

<div id="view-classic" class="hidden">
    <header style="background: var(--classic);">
        <h1>Socio Classic üê∂</h1>
        <p>ID: <span id="display-id-classic">...</span></p>
    </header>
    <div class="container">
        <div class="card">
            <h3 id="saludo-classic">Hola!</h3>
            <h3>üéÅ Tu Progreso de Sacos</h3>
            <p id="texto-sacos-classic">Cargando...</p>
            <div class="progress-container">
                <span class="progress-text" id="label-barra-classic">0/10</span>
                <div class="progress-fill" id="barra-classic" style="background: var(--classic);"></div>
            </div>
            <p id="mensaje-falta-classic" style="font-size:0.8rem; color:#999; text-align: center;">...</p>

            <a href="#" onclick="registrarSaco('Classic')" class="btn btn-classic">üõí Registrar Nuevo Saco</a>
        </div>
        
        <div class="card">
            <span style="background: var(--classic); color: white; padding: 4px 10px; border-radius: 15px; font-size: 0.8rem;">ACTIVO</span>
            <h3>5% Descuento en Tienda</h3>
            <p>Muestra esta pantalla en caja para validar tu descuento.</p>
        </div>

        <button onclick="cerrarSesion()" class="btn btn-outline">Cerrar Sesi√≥n</button>
    </div>
</div>

<div id="view-elite" class="hidden">
    <header style="background: var(--elite); color: #333;">
        <h1>Socio √âlite üëë</h1>
        <p>ID: <span id="display-id-elite">...</span></p>
    </header>
    <div class="container">
        <div class="card" style="background: linear-gradient(to right, #fff, #fffdf5);">
            <h3 id="saludo-elite">Hola!</h3>
            <h3>üéÅ Progreso de Sacos</h3>
            <p id="texto-sacos-elite">Cargando...</p>
            <div class="progress-container">
                <span class="progress-text" id="label-barra-elite">0/10</span>
                <div class="progress-fill" id="barra-elite" style="background: var(--elite);"></div>
            </div>
             <a href="#" onclick="registrarSaco('Elite')" class="btn btn-elite">üõí Registrar Nuevo Saco</a>
        </div>

        <div class="card">
            <span style="background: var(--elite); color: #333; padding: 4px 10px; border-radius: 15px; font-size: 0.8rem;">VIP ACTIVO</span>
            <h3>10% Descuento Permanente</h3>
            <p>V√°lido en todos los productos y servicios.</p>
        </div>

        <div class="card">
            <h3>üéâ Sorteos Mensuales</h3>
            <p>Participas autom√°ticamente.</p>
            <a href="#" onclick="window.open(LINK_INSTAGRAM, '_blank')" class="btn btn-insta">üì∏ Ver Premios en Instagram</a>
        </div>
        
        <div class="card">
            <h3>üí≥ Reposici√≥n Gratuita</h3>
            <p>Tienes 3 reposiciones al a√±o sin costo.</p>
            <a href="#" onclick="conectarWhatsApp('Hola, soy Socio Elite y necesito reponer mi tarjeta gratis.')" class="btn btn-outline">Solicitar Reposici√≥n</a>
        </div>

        <button onclick="cerrarSesion()" class="btn btn-outline">Cerrar Sesi√≥n</button>
    </div>
</div>

<script type="module">
    // --- CONFIGURACI√ìN FIREBASE ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, getDoc, addDoc, collection } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // ‚ö†Ô∏è CONFIGURACI√ìN REAL (AGREGADA) ‚ö†Ô∏è
    const firebaseConfig = {
        apiKey: "AIzaSyCj49Ndnx5dzoSnOd60hGddI3t4ElFl_Vk",
        authDomain: "petsjack.firebaseapp.com",
        projectId: "petsjack",
        storageBucket: "petsjack.firebasestorage.app",
        messagingSenderId: "647166319900",
        appId: "1:647166319900:web:2a4e40d6ea8c9551a46ed9",
        measurementId: "G-M7S527YE2B"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // VARIABLES GLOBALES
    window.WHATSAPP_TIENDA = "56993525112"; 
    window.LINK_INSTAGRAM = "https://www.instagram.com/pets.jackk/";
    let currentId = null;
    let registroTipoSeleccionado = 'classic';

    // --- INICIO DE LA APP ---
    window.onload = async function() {
        const params = new URLSearchParams(window.location.search);
        const idUsuario = params.get('id');

        // Ocultar todo
        ocultarTodo();

        if(idUsuario) {
            // Si hay ID en la URL, cargamos al usuario
            currentId = idUsuario;
            cargarUsuario(idUsuario);
        } else {
            // Si no hay ID, mostramos la vista p√∫blica para elegir/registrar
            document.getElementById('view-public').classList.remove('hidden');
        }
    };

    function ocultarTodo() {
        document.getElementById('view-public').classList.add('hidden');
        document.getElementById('view-registro').classList.add('hidden');
        document.getElementById('view-classic').classList.add('hidden');
        document.getElementById('view-elite').classList.add('hidden');
    }

    async function cargarUsuario(id) {
        // Mostrar mensaje de carga
        document.getElementById('display-id-classic').innerText = "Cargando...";
        document.getElementById('display-id-elite').innerText = "Cargando...";

        try {
            const docRef = doc(db, "clientes", id);
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
                const data = docSnap.data();
                const tipo = data.tipo || 'classic';
                
                // Mostrar ID visible (recortado)
                let idVisible = id.substring(0, 8).toUpperCase();
                document.getElementById('display-id-classic').innerText = idVisible;
                document.getElementById('display-id-elite').innerText = idVisible;

                // Saludo personalizado
                if(data.nombre) {
                    document.getElementById('saludo-classic').innerText = `Hola, ${data.nombre}`;
                    document.getElementById('saludo-elite').innerText = `Hola, ${data.nombre}`;
                }

                actualizarGraficos(data.sacos || 0);

                // Mostrar la vista correspondiente
                if (tipo === 'elite') {
                    document.getElementById('view-elite').classList.remove('hidden');
                } else {
                    document.getElementById('view-classic').classList.remove('hidden');
                }

            } else {
                alert("ID no encontrado. Reg√≠strate nuevamente.");
                document.getElementById('view-public').classList.remove('hidden');
            }
        } catch (error) {
            console.error("Error:", error);
            alert("Error de conexi√≥n. Verifica tu internet.");
        }
    }

    // --- FUNCIONES DE REGISTRO ---

    window.abrirFormularioRegistro = function(tipo) {
        registroTipoSeleccionado = tipo; 
        
        const titulo = document.getElementById('titulo-registro');
        titulo.innerText = tipo === 'elite' ? 'Registro Socio √âlite üëë' : 'Registro Socio Classic üîµ';
        
        ocultarTodo();
        document.getElementById('view-registro').classList.remove('hidden');
    }

    window.cancelarRegistro = function() {
        ocultarTodo();
        document.getElementById('view-public').classList.remove('hidden');
    }

    window.guardarRegistro = async function() {
        const nombre = document.getElementById('reg-nombre').value;
        const telefono = document.getElementById('reg-telefono').value;
        const btn = document.getElementById('btn-confirmar-reg');

        if (!nombre || !telefono) {
            alert("Por favor completa nombre y tel√©fono");
            return;
        }

        btn.innerText = "Guardando...";
        btn.disabled = true;

        try {
            // GUARDAR EN FIREBASE
            const docRef = await addDoc(collection(db, "clientes"), {
                nombre: nombre,
                telefono: telefono,
                tipo: registroTipoSeleccionado,
                sacos: 0, 
                fecha_registro: new Date()
            });

            alert(`¬°Registro Exitoso! Tu ID es: ${docRef.id}`);
            window.location.href = `?id=${docRef.id}`;

        } catch (e) {
            console.error("Error al registrar: ", e);
            alert("Hubo un error al guardar. Intenta de nuevo.");
            btn.innerText = "Confirmar y Crear ID";
            btn.disabled = false;
        }
    }

    // --- L√ìGICA GR√ÅFICA Y UTILIDADES ---

    function actualizarGraficos(n) {
        n = parseInt(n) || 0;
        let porcentaje = (n / 10) * 100;
        if (porcentaje > 100) porcentaje = 100;
        let faltan = 10 - n;
        let mensaje = faltan <= 0 ? "¬°Premio disponible!" : `Faltan ${faltan} sacos para tu premio.`;

        // Classic
        document.getElementById('texto-sacos-classic').innerHTML = `Llevas <strong>${n} de 10</strong> sacos.`;
        document.getElementById('label-barra-classic').innerText = `${n}/10`;
        document.getElementById('barra-classic').style.width = `${porcentaje}%`;
        document.getElementById('mensaje-falta-classic').innerText = mensaje;

        // Elite
        document.getElementById('texto-sacos-elite').innerHTML = `Llevas <strong>${n} de 10</strong> sacos.`;
        document.getElementById('label-barra-elite').innerText = `${n}/10`;
        document.getElementById('barra-elite').style.width = `${porcentaje}%`;
    }

    window.conectarWhatsApp = function(mensaje) {
        let numero = window.WHATSAPP_TIENDA.replace(/\D/g,'');
        let url = `https://wa.me/${numero}?text=${encodeURIComponent(mensaje)}`;
        window.open(url, '_blank');
    }

    window.registrarSaco = function(tipoSocio) {
        let msg = `Hola, soy Socio ${tipoSocio} (ID: ${currentId}). Quiero registrar un saco.`;
        window.conectarWhatsApp(msg);
    }

    window.cerrarSesion = function() {
        window.location.href = window.location.pathname.split('?')[0];
    }
</script>

</body>
</html>
